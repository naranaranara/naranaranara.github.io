---
layout: post
title:  "GNN"
toc: true          # 우측 목차
toc_sticky: true   # 스크롤해도 고정
date: 2026-01-13
tags: [markdown, blog]
use_math: true
mathjax: true
---
## GNN 알고리즘  

**전체흐름**  

Reader.py (FEBio raw) $\rightarrow$ Standardln.npz(+메타 json) 생성  $\rightarrow$ Convert.py (그래프 변환)  $\rightarrow$  StandardOut.pt 파일 생성  $\rightarrow$ Learner.py (학습 추론)  

1\. Reader.py: FEBio 결과 (Sim.feb[메시], Globals.csv[시간마다 노드 위치/변위/속도 값], SimData*.csv[전역조건])를 읽어서 모델이 공통으로 쓰는 표준 입력 포맷으로 패킹하고 StandardIn*.npz와 StandardInCompanion.json을 저장  

2\. Convertor.py: Standardln.npz(+JSON)을 로드해서 각 시뮬레이션/시간스텝을 torch_geometric.data.Data 그래프로 변환 (node feature, edge_index, graph_level,face 등)하고, 리스트 형태로 StandardOutput.pt에 torch.save 함  

3\. Learner.py: 실행 시 TOML 설정을 읽고 (TrainOrEmulate, 데이터셋 이름/분할, 네트워크/옵티마 설정 등), StandardOut.pt 기반으로 모델(classdef.py)을 구성한 뒤 학습/검증/테스트 또는 추론을 수행하고 로그/체크포인트를 저장  

## 코드 수정  

**1\. Reader.py**  

```python
febioElementType = 'hex8'
```

- Sim.feb의 본 메쉬 요소가 hex8이여서 quad4를 hex8로 변경  
- Reader.py 는 febioElementType에 따라 ./Mesh/Elements[@type="..."]/elem를 읽어 edge/Connectivity를 만드는데, quad4로 두면 Mesh/Elements[@type="quad4"]가 없어서 요소를 못 읽고 edge가 0개가 되는 문제 발생

**2\. Convertor.py**  

Converotr.py에는 ConnectivityData를 이미 face(삼각형) 리스트라고 가정한다.  
하지만 hex8은 노드가 8개인 육면체이므로 hex(볼륨요소)$\rightarrow$ boundaryquad $\rightarrow$ triangle face로 바꿔주는 로직 추가  

```python
def tri_faces_from_connectivity(connectivity, pos_ref):
    conn = np.asarray(connectivity)

    if conn.shape[1] == 3:   # already triangles
        return conn.astype(np.int64)

    if conn.shape[1] == 4:   # quad -> 2 tris
        q = conn.astype(np.int64)
        return np.vstack([q[:, [0,1,2]], q[:, [0,2,3]]])

    if conn.shape[1] != 8:
        raise ValueError(f"Unsupported ConnectivityData shape: {conn.shape}")

    face_idx = np.array([
        [0,1,2,3], [4,5,6,7],
        [0,1,5,4], [1,2,6,5], [2,3,7,6], [3,0,4,7],
    ], dtype=np.int64)

    counts = {}
    oriented = {}
    for elem in conn.astype(np.int64):
        elem_center = pos_ref[elem].mean(axis=0)
        for idx in face_idx:
            face = elem[idx]
            a,b,c = pos_ref[face[0]], pos_ref[face[1]], pos_ref[face[2]]
            n = np.cross(b-a, c-a)
            face_center = pos_ref[face].mean(axis=0)
            if np.dot(n, face_center - elem_center) < 0:
                face = face[::-1]  # flip winding
            key = tuple(sorted(face))
            counts[key] = counts.get(key, 0) + 1
            oriented.setdefault(key, face)

    boundary_quads = np.stack([oriented[k] for k,v in counts.items() if v == 1], axis=0)
    return np.vstack([boundary_quads[:, [0,1,2]], boundary_quads[:, [0,2,3]]])
```

3\. 새로운 toml 파일 생성  

- 기존 toml 파일을 복사해서 수정
  - Settings.Case.SetName: 데이터가 들어있는 폴더명
  - n_train/n_valid/n_test: 데이터셋의 전체 graph 개수에 맞는 분할
  - GraphFeatDim 같은 입력 차원 관련 값: Reader.py 에서 만든 n_g(globals 개수)와 일치해야 함

4\. Learner.py  

- toml 파일에서 NN 모듈 컴파일하는거 끄기
  ```python
  FlagCompileTheNNModule = false
  ```
  - 내부적으로 그래프를 만들고 최적화해서 계산 속도 빠르게 하는 기능
  - CUDA용 옵션이라서 CPU를 사용할 때는 안됨

- Laerner.py 에서 fused=True 조건 삭제
  - 이 옵션은 Adam 업데이트에 필요한 여러 연산을 한 커널로 묶어서 한번에 처리하는 기능
  - 근데 이 옵션은 CPU에서 지원 안함. GPU 전용



